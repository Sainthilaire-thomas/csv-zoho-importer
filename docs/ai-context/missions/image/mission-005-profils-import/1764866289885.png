# ğŸ¯ Mission 006: Preview des Transformations

*CrÃ©Ã©e le 2025-12-04*
*Statut : ğŸ†• Nouvelle*

---

## Objectif

Ajouter une Ã©tape de **prÃ©visualisation des transformations** dans le wizard d'import, permettant Ã  l'utilisateur de voir exactement comment ses donnÃ©es seront modifiÃ©es avant l'envoi Ã  Zoho Analytics.

---

## Contexte

### Mission prÃ©cÃ©dente

* Lien : `missions/mission-005-profils-import.md`
* Statut : âœ… ComplÃ©tÃ©e (4 sessions)
* Points clÃ©s : SystÃ¨me de profils d'import complet avec matching intelligent, Ã©dition/suppression, clÃ© de matching pour modes UPDATE*

### Documents de rÃ©fÃ©rence

* `docs/specs-preview-verification.md` - SpÃ©cification dÃ©taillÃ©e (Ã  crÃ©er)
* `docs/specs-profils-import-v2.1.md` - Formats universels et transformations
* `docs/architecture-cible-v3.md` - Architecture technique

### Ã‰tat actuel

Le wizard actuel (7 Ã©tapes) applique les transformations de maniÃ¨re transparente mais l'utilisateur ne voit pas le dÃ©tail de ce qui sera modifiÃ©. Il doit faire confiance au systÃ¨me sans pouvoir vÃ©rifier.

---

## ProblÃ¨me Ã  rÃ©soudre

### Situation actuelle

```
Fichier source          EnvoyÃ© Ã  Zoho
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 05/03/2025  â”‚   ???   â”‚ 2025-03-05  â”‚
â”‚ 1 234,56    â”‚  â”€â”€â”€â–¶   â”‚ 1234.56     â”‚
â”‚ 9:30        â”‚         â”‚ 09:30:00    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
L'utilisateur ne voit pas ces transformations
```

### Solution proposÃ©e

```
Fichier source     Transformation          EnvoyÃ© Ã  Zoho
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 05/03/2025  â”‚ â”€â–¶ â”‚ JJ/MM â†’ ISO     â”‚ â”€â–¶  â”‚ 2025-03-05  â”‚
â”‚ 1 234,56    â”‚ â”€â–¶ â”‚ Virgule â†’ Point â”‚ â”€â–¶  â”‚ 1234.56     â”‚
â”‚ 9:30        â”‚ â”€â–¶ â”‚ DurÃ©e padding   â”‚ â”€â–¶  â”‚ 09:30:00    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Vue comparative avec indicateurs visuels
```

---

## Fichiers concernÃ©s

### Ã€ crÃ©er

| Fichier | Description |
|---------|-------------|
| `components/import/wizard/step-transform-preview.tsx` | Composant principal de preview |
| `lib/domain/transformation/preview.ts` | Logique de gÃ©nÃ©ration des previews |
| `docs/specs-preview-verification.md` | SpÃ©cification complÃ¨te |

### Ã€ modifier

| Fichier | Modification |
|---------|--------------|
| `components/import/import-wizard.tsx` | Ajouter Ã©tape 6 (preview), dÃ©caler confirm Ã  7 |
| `components/import/wizard/wizard-progress.tsx` | Passer de 7 Ã  8 Ã©tapes |

### Ã€ consulter (rÃ©fÃ©rence)

| Fichier | Raison |
|---------|--------|
| `lib/domain/transformation/transformers.ts` | Logique de transformation existante |
| `lib/domain/detection/type-detector.ts` | DÃ©tection des types |
| `types/validation.ts` | Types de transformations |

---

## SpÃ©cification fonctionnelle

### Vue comparative par colonne

Pour chaque colonne avec transformation, afficher un Ã©chantillon (5-10 lignes) :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PrÃ©visualisation des transformations                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Colonne: "Date dÃ©but" (type Zoho: DATE)                                   â”‚
â”‚  Transformation: JJ/MM/AAAA â†’ AAAA-MM-JJ (ISO 8601)                        â”‚
â”‚                                                                             â”‚
â”‚  #  â”‚ Fichier source   â”‚ Sera envoyÃ©       â”‚ Statut                        â”‚
â”‚  â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  1  â”‚ 05/03/2025       â”‚ 2025-03-05        â”‚ ğŸ”„ TransformÃ©                 â”‚
â”‚  2  â”‚ 06/03/2025       â”‚ 2025-03-06        â”‚ ğŸ”„ TransformÃ©                 â”‚
â”‚  3  â”‚ N/A              â”‚ (vide)            â”‚ âš ï¸ Valeur vide normalisÃ©e     â”‚
â”‚  4  â”‚ 07/03/2025       â”‚ 2025-03-07        â”‚ ğŸ”„ TransformÃ©                 â”‚
â”‚  5  â”‚ 08/03/2025       â”‚ 2025-03-08        â”‚ ğŸ”„ TransformÃ©                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Types de transformations et indicateurs

| Type | Source | â†’ EnvoyÃ© | Indicateur |
|------|--------|----------|------------|
| Date FRâ†’ISO | 05/03/2025 | 2025-03-05 | ğŸ”„ TransformÃ© |
| Nombre FRâ†’US | 1 234,56 | 1234.56 | ğŸ”„ TransformÃ© |
| DurÃ©e padding | 9:30 | 09:30:00 | ğŸ”„ TransformÃ© |
| Scientifique | 1E6 | 1000000 | ğŸ”„ DÃ©veloppÃ© |
| Trim espaces | "  texte  " | "texte" | ğŸ”„ NettoyÃ© |
| Vide normalisÃ© | "N/A" | "" | âš ï¸ Vide |
| Aucune | "ABC123" | "ABC123" | âœ… InchangÃ© |

### RÃ©sumÃ© global

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RÃ©sumÃ© des transformations                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ“Š 14 lignes Ã— 22 colonnes = 308 valeurs                                  â”‚
â”‚                                                                             â”‚
â”‚  ğŸ”„ Colonnes transformÃ©es (4) :                                             â”‚
â”‚     â€¢ Date dÃ©but    : JJ/MM/AAAA â†’ ISO (14 valeurs)                        â”‚
â”‚     â€¢ Date fin      : JJ/MM/AAAA â†’ ISO (14 valeurs)                        â”‚
â”‚     â€¢ Heure dÃ©but   : H:mm â†’ HH:mm:ss (14 valeurs)                         â”‚
â”‚     â€¢ Montant       : virgule â†’ point (14 valeurs)                         â”‚
â”‚                                                                             â”‚
â”‚  âœ… Colonnes inchangÃ©es (18) :                                              â”‚
â”‚     Journal, NumÃ©ro Quittance, RÃ©seau, Ligne, ArrÃªt, ...                   â”‚
â”‚                                                                             â”‚
â”‚  âš ï¸ Points d'attention :                                                    â”‚
â”‚     â€¢ 2 valeurs vides normalisÃ©es (N/A â†’ vide)                             â”‚
â”‚                                                                             â”‚
â”‚  Total : 56 transformations sur 308 valeurs (18%)                          â”‚
â”‚                                                                             â”‚
â”‚                      [â—€ Retour]  [Confirmer et continuer â–¶]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## SpÃ©cification technique

### Interface TransformPreview

```typescript
// types/transformation.ts

interface TransformPreviewColumn {
  columnName: string;
  zohoType: string;
  transformationType: TransformationType | null;
  transformationLabel: string;
  samples: TransformPreviewSample[];
}

interface TransformPreviewSample {
  rowIndex: number;
  sourceValue: string;
  transformedValue: string;
  status: 'transformed' | 'unchanged' | 'empty' | 'error';
}

interface TransformPreviewSummary {
  totalRows: number;
  totalColumns: number;
  totalValues: number;
  transformedColumns: {
    name: string;
    type: string;
    count: number;
  }[];
  unchangedColumns: string[];
  warnings: {
    type: string;
    count: number;
    message: string;
  }[];
  totalTransformations: number;
  transformationPercentage: number;
}

interface TransformPreviewResult {
  columns: TransformPreviewColumn[];
  summary: TransformPreviewSummary;
}
```

### Fonction generateTransformPreview

```typescript
// lib/domain/transformation/preview.ts

export function generateTransformPreview(
  data: Record<string, unknown>[],
  columnMappings: ColumnMapping[],
  resolvedIssues: IssueResolution[],
  sampleSize: number = 5
): TransformPreviewResult {
  // 1. Pour chaque colonne avec transformation
  // 2. Extraire N Ã©chantillons
  // 3. Appliquer transformation
  // 4. Comparer source vs transformÃ©
  // 5. GÃ©nÃ©rer rÃ©sumÃ©
}
```

### Props du composant

```typescript
// components/import/wizard/step-transform-preview.tsx

interface StepTransformPreviewProps {
  data: Record<string, unknown>[];
  columnMappings: ColumnMapping[];
  resolvedIssues: IssueResolution[];
  zohoColumns: ZohoColumn[];
  onBack: () => void;
  onConfirm: () => void;
}
```

---

## Actions planifiÃ©es

### Phase 1 : SpÃ©cification (30 min)

- [ ] CrÃ©er `docs/specs-preview-verification.md`
- [ ] Valider avec utilisateur

### Phase 2 : Logique mÃ©tier (1h30)

- [ ] CrÃ©er types dans `types/transformation.ts`
- [ ] ImplÃ©menter `lib/domain/transformation/preview.ts`
- [ ] Tests unitaires basiques

### Phase 3 : Composant UI (2h)

- [ ] CrÃ©er `step-transform-preview.tsx`
- [ ] Vue dÃ©taillÃ©e par colonne (accordÃ©on)
- [ ] RÃ©sumÃ© global
- [ ] Indicateurs visuels (ğŸ”„, âœ…, âš ï¸)

### Phase 4 : IntÃ©gration wizard (30 min)

- [ ] Modifier `import-wizard.tsx` (ajouter Ã©tape)
- [ ] Modifier `wizard-progress.tsx` (8 Ã©tapes)
- [ ] Tester flux complet

---

## CritÃ¨res de succÃ¨s

### Fonctionnel

- [ ] L'utilisateur voit chaque transformation avant import
- [ ] Vue comparative source / transformÃ© claire
- [ ] RÃ©sumÃ© avec statistiques (colonnes, valeurs, %)
- [ ] Navigation retour possible pour modifier

### Technique

- [ ] Build sans erreur TypeScript
- [ ] Performance OK avec 10 000+ lignes (sampling)
- [ ] Composant rÃ©utilisable

### Tests manuels

- [ ] Import QUITTANCES avec transformations dates + nombres
- [ ] Import sans transformation (tout vert)
- [ ] Import avec valeurs vides

---

## Wizard mis Ã  jour (8 Ã©tapes)

```
1. SÃ©lection fichier     Upload CSV/Excel
        â†“
2. Profil import         Matching profil ou crÃ©ation
        â†“
3. Configuration         Workspace/table + mode import
        â†“
4. Validation            Validation schÃ©ma colonnes
        â†“
5. RÃ©solution            Formats ambigus (si nÃ©cessaire)
        â†“
6. Preview               â† NOUVELLE Ã‰TAPE
        â†“
7. VÃ©rification          RÃ©capitulatif final
        â†“
8. Import                Envoi + confirmation
```

---

## Risques et points d'attention

| Risque | ProbabilitÃ© | Mitigation |
|--------|-------------|------------|
| Performance avec gros fichiers | Moyenne | Sampling (5-10 lignes par colonne) |
| UI trop complexe | Faible | AccordÃ©on repliÃ© par dÃ©faut, rÃ©sumÃ© visible |
| Redondance avec Ã©tape RÃ©solution | Moyenne | RÃ©solution = dÃ©cider du format, Preview = voir le rÃ©sultat |

---

## Estimation

| Phase | Effort |
|-------|--------|
| SpÃ©cification | 30 min |
| Logique mÃ©tier | 1h30 |
| Composant UI | 2h |
| IntÃ©gration wizard | 30 min |
| Tests | 30 min |
| **Total** | **5h** |

---

## Notes de session

### DÃ©cisions prises

* [Ã€ complÃ©ter pendant la session]

### ProblÃ¨mes rencontrÃ©s

* [Ã€ complÃ©ter pendant la session]

### Questions en suspens

* [Ã€ complÃ©ter pendant la session]

---

# ğŸ“‹ BILAN DE SESSION

*Ã€ complÃ©ter en fin de session*

## âœ… Travail accompli

* [ ] Item 1

## ğŸ“ Fichiers modifiÃ©s

| Fichier | Action | Description |
|---------|--------|-------------|
| - | - | - |

## ğŸ“Š MÃ©triques

| MÃ©trique | Valeur |
|----------|--------|
| Fichiers crÃ©Ã©s | - |
| Fichiers modifiÃ©s | - |
| Lignes de code ajoutÃ©es | - |
| DurÃ©e de session | - |

## â³ Reste Ã  faire

* [ ] -

---

*Mission crÃ©Ã©e le : 2025-12-04*
*DerniÃ¨re mise Ã  jour : 2025-12-04*
*Statut : ğŸ†• Nouvelle*
